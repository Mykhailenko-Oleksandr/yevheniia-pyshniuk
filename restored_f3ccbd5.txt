"use client";

import { register } from "@/lib/api/clientApi";
import css from "./Register.module.css";
import { ErrorMessage, Field, Form, Formik, FormikHelpers } from "formik";
import * as Yup from "yup";
import { useAuthStore } from "@/lib/store/authStore";
import { ApiError } from "@/app/api/api";
import toast from "react-hot-toast";
import { useLocale } from "next-intl";
import { useRouter } from "@/i18n/navigation";

interface FormData {
  name: string;
  email: string;
  password: string;
  confirmPassword: string;
}

const RegistrationFormSchema = Yup.object({
  name: Yup.string()
    .min(2, "Ім’я повинно містити щонайменше 2 символи")
    .max(32, "Ім’я повинно містити не більше 32 символів")
    .required("Ім’я є обов’язковим"),

  email: Yup.string()
    .email("Неправильний формат електронної пошти")
    .max(64, "Електронна пошта повинна містити не більше 64 символів")
    .required("Електронна пошта є обов’язковою"),

  password: Yup.string()
    .min(8, "Пароль повинний містити щонайменше 8 символів")
    .max(128, "Пароль повинний містити не більше 128 символів")
    .required("Пароль є обов’язковим"),

  confirmPassword: Yup.string()
    .oneOf([Yup.ref("password")], "Паролі не співпадають")
    .required("Підтвердження пароля є обов’язковим"),
});

export default function Register() {
  const router = useRouter();
  const { setUser } = useAuthStore();
  const locale = useLocale();

  const handleSubmit = async (
    values: FormData,
    formikHelpers: FormikHelpers<FormData>,
  ) => {
    try {
      const newUser = await register({
        name: values.name,
        email: values.email,
        password: values.password,
      });

      setUser(newUser);
      formikHelpers.resetForm();
      router.replace("/profile");
    } catch (error: unknown) {
      const err = error as ApiError;

      toast.error(
        err.response?.data?.response?.validation?.body?.message ||
          err.response?.data?.response?.message ||
          err.message,
      );
    }
  };

  return (
    <Formik
      initialValues={{
        name: "",
        email: "",
        password: "",
        confirmPassword: "",
      }}
      onSubmit={handleSubmit}
      validationSchema={RegistrationFormSchema}
    >
      {({ isSubmitting, isValid, dirty }) => (
        <Form className={css.form}>
          <fieldset className={css.fieldset}>
            <legend className={css.title}>Реєстрація</legend>
            <div className={css.inputWrapper}>
              <label htmlFor="name">Ім&#39;я*</label>
              <Field
                id="name"
                name="name"
                type="text"
                className={css.formInput}
                placeholder="Ваше ім'я"
              />
              <ErrorMessage
                name="name"
                component="span"
                className={css.formError}
              />
            </div>

            <div className={css.inputWrapper}>
              <label htmlFor="email">Пошта*</label>
              <Field
                id="email"
                name="email"
                type="email"
                className={css.formInput}
                placeholder="Ваша пошта"
              />
              <ErrorMessage
                name="email"
                component="span"
                className={css.formError}
              />
            </div>

            <div className={css.inputWrapper}>
              <label htmlFor="password">Пароль*</label>
              <Field
                id="password"
                name="password"
                type="password"
                className={css.formInput}
                placeholder="*******"
              />
              <ErrorMessage
                name="password"
                component="span"
                className={css.formError}
              />
            </div>

            <div className={css.inputWrapper}>
              <label htmlFor="confirmPassword">Підтвердіть пароль*</label>
              <Field
                id="confirmPassword"
                name="confirmPassword"
                type="password"
                className={css.formInput}
                placeholder="*******"
              />
              <ErrorMessage
                name="confirmPassword"
                component="span"
                className={css.formError}
              />
            </div>
            <button
              type="submit"
              className={css.btn}
              disabled={isSubmitting || !isValid || !dirty}
            >
              Зареєструватися
            </button>
          </fieldset>
        </Form>
      )}
    </Formik>
  );
}
